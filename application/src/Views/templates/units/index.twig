{% extends "base.twig" %}

{% block page_actions %}
    {% set current_auth = auth() %}
    {% if current_auth.is_admin %}
        <div class="btn-toolbar">
            <a href="/units/create" class="btn btn-info">
                <i class="fas fa-plus me-1"></i>Add University Unit
            </a>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table id="unitsTable" class="table table-striped table-hover nowrap" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>Unit Name</th>
                        <th>Code</th>
                        <th>Type</th>
                        <th>Parent Unit</th>
                        <th>Software Count</th>
                        <th>Last Updated</th>
                        {% set current_auth = auth() %}
                        {% if current_auth.is_admin %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    var currentAuth = {{ auth() | json_encode | raw }};
    
    // Define columns array
    var columns = [
        { 
            data: 'unit_name',
            render: function(data, type, row) {
                return '<a href="/units/' + row.id + '" class="text-decoration-none">' + 
                       '<i class="fas fa-building me-1"></i>' + data + '</a>';
            },
            responsivePriority: 1
        },
        { 
            data: 'unit_code',
            render: function(data, type, row) {
                return data || '<span class="text-muted">N/A</span>';
            },
            responsivePriority: 3
        },
        { 
            data: 'unit_type',
            render: function(data, type, row) {
                var typeColors = {
                    'Department': 'primary',
                    'College': 'success',
                    'Administrative': 'warning text-dark',
                    'Support': 'info',
                    'Research': 'secondary'
                };
                var colorClass = typeColors[data] || 'secondary';
                return '<span class="badge bg-' + colorClass + '">' + data + '</span>';
            },
            responsivePriority: 2
        },
        { 
            data: 'parent_unit_name',
            render: function(data, type, row) {
                return data !== 'None' ? data : '<span class="text-muted">None</span>';
            },
            responsivePriority: 5
        },
        { 
            data: 'software_count',
            render: function(data, type, row) {
                return data > 0 ? '<span class="badge bg-secondary">' + data + '</span>' : 
                       '<span class="text-muted">0</span>';
            },
            responsivePriority: 4
        },
        { 
            data: 'updated_at',
            responsivePriority: 5
        }
    ];

    // Add actions column only if user is admin
    if (currentAuth.is_admin) {
        columns.push({ 
            data: null,
            render: function(data, type, row) {
                var actions = '<div class="btn-group btn-group-sm table-actions" role="group">' +
                       '<a href="/units/' + row.id + '/edit" class="btn btn-outline-warning btn-sm" title="Edit">' +
                       '<i class="fas fa-edit"></i></a>' +
                       '<button type="button" class="btn btn-outline-danger btn-sm" title="Delete" ' +
                       'onclick="confirmDelete(\'unit\', ' + row.id + ', \'' + row.unit_name.replace(/'/g, "\\'") + '\', \'/units/delete\')">' +
                       '<i class="fas fa-trash"></i></button></div>';
                return actions;
            },
            orderable: false,
            searchable: false,
            responsivePriority: 7
        });
    }
    
    $('#unitsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/units/data',
            type: 'GET'
        },
        columns: columns,
        order: [[0, 'asc']],
        pageLength: 25,
        responsive: true,
        scrollX: true,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'csv',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'excel',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'pdf',
                className: 'btn btn-secondary btn-sm'
            }
        ],
        language: {
            processing: '<div class="d-flex align-items-center">' +
                       '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' +
                       'Loading university units...</div>',
            emptyTable: 'No university units found',
            info: 'Showing _START_ to _END_ of _TOTAL_ units',
            infoEmpty: 'No units to display',
            infoFiltered: '(filtered from _MAX_ total units)'
        }
    });
    
    // Initialize tooltips for action buttons
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}
