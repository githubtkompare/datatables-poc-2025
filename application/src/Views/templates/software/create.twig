{% extends "base.twig" %}

{% block page_actions %}
    <div class="btn-toolbar">
        <a href="/software" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Software
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-laptop-code me-2"></i>Add New Software Product
                </h5>
            </div>
            <div class="card-body">
                {% if errors %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Please correct the following errors:</strong>
                        <ul class="mb-0 mt-2">
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <form method="POST" action="/software/create">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="software_name" class="form-label">
                                    Software Name <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="software_name" 
                                    name="software_name" 
                                    value="{{ form_data.software_name|default('') }}"
                                    required
                                    maxlength="255"
                                    placeholder="e.g. Adobe Photoshop, Microsoft Office"
                                    list="software_names_list"
                                    autocomplete="off"
                                >
                                <datalist id="software_names_list">
                                </datalist>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="version" class="form-label">Version</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="version" 
                                    name="version" 
                                    value="{{ form_data.version|default('') }}"
                                    maxlength="50"
                                    placeholder="e.g. 2024, v1.5.2"
                                    list="version_list"
                                    autocomplete="off"
                                >
                                <datalist id="version_list">
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea 
                            class="form-control" 
                            id="description" 
                            name="description" 
                            rows="3"
                            maxlength="1000"
                            placeholder="Brief description of the software and its purpose"
                        >{{ form_data.description|default('') }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vendor Management</label>
                                <div class="form-check">
                                    <input 
                                        class="form-check-input" 
                                        type="radio" 
                                        name="vendor_managed" 
                                        id="vendor_managed_no" 
                                        value="0"
                                        {% if form_data.vendor_managed is not defined or form_data.vendor_managed == '0' %}checked{% endif %}
                                    >
                                    <label class="form-check-label" for="vendor_managed_no">
                                        <i class="fas fa-users me-1"></i>Self Managed
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input 
                                        class="form-check-input" 
                                        type="radio" 
                                        name="vendor_managed" 
                                        id="vendor_managed_yes" 
                                        value="1"
                                        {% if form_data.vendor_managed == '1' %}checked{% endif %}
                                    >
                                    <label class="form-check-label" for="vendor_managed_yes">
                                        <i class="fas fa-building me-1"></i>Vendor Managed
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vendor_name" class="form-label">Vendor Name</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="vendor_name" 
                                    name="vendor_name" 
                                    value="{{ form_data.vendor_name|default('') }}"
                                    maxlength="255"
                                    placeholder="e.g. Microsoft, Adobe, Oracle"
                                    list="vendor_list"
                                    autocomplete="off"
                                >
                                <datalist id="vendor_list">
                                </datalist>
                                <div class="form-text">Only required if vendor managed</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="license_type" class="form-label">License Type</label>
                        <select class="form-control" id="license_type" name="license_type">
                            <option value="">Select license type...</option>
                            <option value="Commercial" {% if form_data.license_type == 'Commercial' %}selected{% endif %}>Commercial</option>
                            <option value="Open Source" {% if form_data.license_type == 'Open Source' %}selected{% endif %}>Open Source</option>
                            <option value="Freeware" {% if form_data.license_type == 'Freeware' %}selected{% endif %}>Freeware</option>
                            <option value="Subscription" {% if form_data.license_type == 'Subscription' %}selected{% endif %}>Subscription</option>
                            <option value="Site License" {% if form_data.license_type == 'Site License' %}selected{% endif %}>Site License</option>
                            <option value="Other" {% if form_data.license_type == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>Role Assignments
                                <span class="text-danger">*</span>
                            </h6>
                            <small class="text-muted">All three roles are required. The software's university unit will be automatically determined by the business owner's university unit.</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="business_owner_id" class="form-label">
                                            <i class="fas fa-briefcase me-1"></i>Business Owner <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control employee-autocomplete" 
                                            id="business_owner_name" 
                                            name="business_owner_name"
                                            placeholder="Type to search for employee..."
                                            list="business_owner_list"
                                            autocomplete="off"
                                            required
                                        >
                                        <input type="hidden" id="business_owner_id" name="business_owner_id" value="">
                                        <datalist id="business_owner_list">
                                        </datalist>
                                        <div class="form-text">Determines the software's university unit</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="technical_owner_id" class="form-label">
                                            <i class="fas fa-cog me-1"></i>Technical Owner <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control employee-autocomplete" 
                                            id="technical_owner_name" 
                                            name="technical_owner_name"
                                            placeholder="Type to search for employee..."
                                            list="technical_owner_list"
                                            autocomplete="off"
                                            required
                                        >
                                        <input type="hidden" id="technical_owner_id" name="technical_owner_id" value="">
                                        <datalist id="technical_owner_list">
                                        </datalist>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="technical_manager_id" class="form-label">
                                            <i class="fas fa-users-cog me-1"></i>Technical Manager <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control employee-autocomplete" 
                                            id="technical_manager_name" 
                                            name="technical_manager_name"
                                            placeholder="Type to search for employee..."
                                            list="technical_manager_list"
                                            autocomplete="off"
                                            required
                                        >
                                        <input type="hidden" id="technical_manager_id" name="technical_manager_id" value="">
                                        <datalist id="technical_manager_list">
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid d-md-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Create Software
                        </button>
                        <a href="/software" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Focus on software name field
    $('#software_name').focus();
    
    // Software name autocomplete functionality
    let autoCompleteTimeout;
    
    function loadAutocompleteSuggestions(query) {
        // Clear previous timeout
        if (autoCompleteTimeout) {
            clearTimeout(autoCompleteTimeout);
        }
        
        // Debounce the API call by 300ms
        autoCompleteTimeout = setTimeout(function() {
            $.ajax({
                url: '/software/autocomplete',
                method: 'GET',
                data: { q: query || '' },
                dataType: 'json',
                success: function(data) {
                    const datalist = $('#software_names_list');
                    datalist.empty(); // Clear existing options
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(function(suggestion) {
                            datalist.append('<option value="' + suggestion + '">');
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching autocomplete suggestions:', error);
                }
            });
        }, 300);
    }
    
    $('#software_name').on('input', function() {
        const query = $(this).val().trim();
        loadAutocompleteSuggestions(query);
    });
    
    // Load all suggestions when field is focused
    $('#software_name').on('focus', function() {
        const query = $(this).val().trim();
        loadAutocompleteSuggestions(query);
    });
    
    // Version autocomplete functionality
    let versionTimeout;
    
    function loadVersionSuggestions(query) {
        if (versionTimeout) {
            clearTimeout(versionTimeout);
        }
        
        versionTimeout = setTimeout(function() {
            $.ajax({
                url: '/software/autocomplete/version',
                method: 'GET',
                data: { q: query || '' },
                dataType: 'json',
                success: function(data) {
                    const datalist = $('#version_list');
                    datalist.empty();
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(function(suggestion) {
                            datalist.append('<option value="' + suggestion + '">');
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching version suggestions:', error);
                }
            });
        }, 300);
    }
    
    $('#version').on('input', function() {
        const query = $(this).val().trim();
        loadVersionSuggestions(query);
    });
    
    $('#version').on('focus', function() {
        const query = $(this).val().trim();
        loadVersionSuggestions(query);
    });
    
    // Vendor autocomplete functionality
    let vendorTimeout;
    
    function loadVendorSuggestions(query) {
        if (vendorTimeout) {
            clearTimeout(vendorTimeout);
        }
        
        vendorTimeout = setTimeout(function() {
            $.ajax({
                url: '/software/autocomplete/vendor',
                method: 'GET',
                data: { q: query || '' },
                dataType: 'json',
                success: function(data) {
                    const datalist = $('#vendor_list');
                    datalist.empty();
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(function(suggestion) {
                            datalist.append('<option value="' + suggestion + '">');
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching vendor suggestions:', error);
                }
            });
        }, 300);
    }
    
    $('#vendor_name').on('input', function() {
        const query = $(this).val().trim();
        loadVendorSuggestions(query);
    });
    
    $('#vendor_name').on('focus', function() {
        const query = $(this).val().trim();
        loadVendorSuggestions(query);
    });
    
    // Employee autocomplete functionality
    let employeeTimeout;
    let selectedEmployees = {}; // Track valid employee selections
    
    function loadEmployeeSuggestions(query, inputField, datalistId) {
        if (employeeTimeout) {
            clearTimeout(employeeTimeout);
        }
        
        employeeTimeout = setTimeout(function() {
            $.ajax({
                url: '/software/autocomplete/employee',
                method: 'GET',
                data: { q: query || '' },
                dataType: 'json',
                success: function(data) {
                    const datalist = $('#' + datalistId);
                    datalist.empty();
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(function(employee) {
                            const displayText = employee.full_name + (employee.job_title ? ' (' + employee.job_title + ')' : '');
                            datalist.append('<option value="' + displayText + '" data-id="' + employee.id + '">');
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching employee suggestions:', error);
                }
            });
        }, 300);
    }
    
    function setupEmployeeAutocomplete(nameField, hiddenField, datalist) {
        $('#' + nameField).on('input', function() {
            const query = $(this).val().trim();
            loadEmployeeSuggestions(query, nameField, datalist);
            
            // Clear hidden field when typing
            $('#' + hiddenField).val('');
            selectedEmployees[nameField] = null;
        });
        
        $('#' + nameField).on('focus', function() {
            const query = $(this).val().trim();
            loadEmployeeSuggestions(query, nameField, datalist);
        });
        
        // Handle selection from datalist
        $('#' + nameField).on('change blur', function() {
            const inputValue = $(this).val().trim();
            const datalistOptions = $('#' + datalist + ' option');
            let found = false;
            
            datalistOptions.each(function() {
                if ($(this).val() === inputValue) {
                    const employeeId = $(this).attr('data-id');
                    $('#' + hiddenField).val(employeeId);
                    selectedEmployees[nameField] = { id: employeeId, name: inputValue };
                    found = true;
                    return false; // break loop
                }
            });
            
            if (!found && inputValue !== '') {
                // Invalid selection - clear the field
                $(this).addClass('is-invalid');
                $('#' + hiddenField).val('');
                selectedEmployees[nameField] = null;
            } else {
                $(this).removeClass('is-invalid');
            }
        });
    }
    
    // Setup autocomplete for all three role fields
    setupEmployeeAutocomplete('business_owner_name', 'business_owner_id', 'business_owner_list');
    setupEmployeeAutocomplete('technical_owner_name', 'technical_owner_id', 'technical_owner_list');
    setupEmployeeAutocomplete('technical_manager_name', 'technical_manager_id', 'technical_manager_list');
    
    // Toggle vendor name field based on vendor managed selection
    function toggleVendorField() {
        const isVendorManaged = $('#vendor_managed_yes').is(':checked');
        const vendorField = $('#vendor_name');
        
        if (isVendorManaged) {
            vendorField.prop('required', true);
            vendorField.closest('.mb-3').find('.form-text').text('Required for vendor managed software');
        } else {
            vendorField.prop('required', false);
            vendorField.val(''); // Clear vendor name when self managed is selected
            vendorField.closest('.mb-3').find('.form-text').text('Only required if vendor managed');
        }
    }
    
    // Initialize and bind vendor management toggle
    toggleVendorField();
    $('input[name="vendor_managed"]').change(toggleVendorField);
    
    // Form validation
    $('form').on('submit', function(e) {
        const softwareName = $('#software_name').val().trim();
        const isVendorManaged = $('#vendor_managed_yes').is(':checked');
        const vendorName = $('#vendor_name').val().trim();
        const businessOwner = $('#business_owner_id').val();
        const technicalOwner = $('#technical_owner_id').val();
        const technicalManager = $('#technical_manager_id').val();
        
        if (!softwareName) {
            e.preventDefault();
            alert('Please enter a software name.');
            $('#software_name').focus();
            return false;
        }
        
        if (isVendorManaged && !vendorName) {
            e.preventDefault();
            alert('Please enter a vendor name for vendor managed software.');
            $('#vendor_name').focus();
            return false;
        }
        
        // Validate role assignments
        if (!businessOwner) {
            e.preventDefault();
            alert('Please select a valid business owner.');
            $('#business_owner_name').focus();
            return false;
        }
        
        if (!technicalOwner) {
            e.preventDefault();
            alert('Please select a valid technical owner.');
            $('#technical_owner_name').focus();
            return false;
        }
        
        if (!technicalManager) {
            e.preventDefault();
            alert('Please select a valid technical manager.');
            $('#technical_manager_name').focus();
            return false;
        }
    });
});
</script>
{% endblock %}
