{% extends "base.twig" %}

{% block page_actions %}
    <div class="btn-toolbar">
        <a href="/software/create" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>Add Software
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table id="softwareTable" class="table table-striped table-hover nowrap" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>Software Name</th>
                        <th>Version</th>
                        <th>Vendor</th>
                        <th>Operating Systems</th>
                        <th>University Unit</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#softwareTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/software/data',
            type: 'GET'
        },
        columns: [
            { 
                data: 'software_name',
                render: function(data, type, row) {
                    var html = '<a href="/software/' + row.id + '" class="text-decoration-none">' + 
                               '<i class="fas fa-laptop-code me-1"></i>' + data + '</a>';
                    
                    // Add warning indicator if there are missing roles
                    if (row.has_role_warnings) {
                        html += ' <i class="fas fa-exclamation-triangle text-warning ms-1" title="Missing role assignments: ' + 
                                row.missing_roles.join(', ') + '"></i>';
                    }
                    
                    return html;
                },
                responsivePriority: 1
            },
            { 
                data: 'version',
                render: function(data, type, row) {
                    return data || '<span class="text-muted">N/A</span>';
                },
                responsivePriority: 4
            },
            { 
                data: null,
                render: function(data, type, row) {
                    if (row.vendor_managed === 'Yes') {
                        return '<span class="badge bg-warning text-dark me-1">Vendor</span>' + 
                               '<span class="text-muted">' + (row.vendor_name || 'Unknown') + '</span>';
                    } else {
                        return '<span class="badge bg-success">Internal</span>';
                    }
                },
                responsivePriority: 3
            },
            { 
                data: 'operating_systems',
                render: function(data, type, row) {
                    if (data) {
                        var systems = data.split(', ');
                        if (systems.length > 2) {
                            return systems.slice(0, 2).join(', ') + ' <span class="text-muted">+' + (systems.length - 2) + ' more</span>';
                        }
                        return data;
                    }
                    return '<span class="text-muted">N/A</span>';
                },
                responsivePriority: 6
            },
            { 
                data: 'university_unit',
                render: function(data, type, row) {
                    if (data && data !== 'Not Assigned') {
                        return '<span class="badge bg-secondary">' + data + '</span>';
                    }
                    return '<span class="text-muted">Not Assigned</span>';
                },
                responsivePriority: 5
            },
            { 
                data: 'created_at',
                responsivePriority: 6
            },
            { 
                data: null,
                render: function(data, type, row) {
                    return '<div class="btn-group btn-group-sm table-actions" role="group">' +
                           '<a href="/software/' + row.id + '/edit" class="btn btn-outline-warning btn-sm" title="Edit">' +
                           '<i class="fas fa-edit"></i></a>' +
                           '<button type="button" class="btn btn-outline-danger btn-sm" title="Delete" ' +
                           'onclick="confirmDelete(\'software\', ' + row.id + ', \'' + row.software_name.replace(/'/g, "\\'") + '\', \'/software/delete\')">' +
                           '<i class="fas fa-trash"></i></button>' +
                           '</div>';
                },
                orderable: false,
                searchable: false,
                responsivePriority: 2
            }
        ],
        order: [[0, 'asc']],
        pageLength: 25,
        responsive: true,
        scrollX: true,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'csv',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'excel',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'pdf',
                className: 'btn btn-secondary btn-sm'
            }
        ],
        language: {
            processing: '<div class="d-flex align-items-center">' +
                       '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' +
                       'Loading software...</div>',
            emptyTable: 'No software products found',
            info: 'Showing _START_ to _END_ of _TOTAL_ software products',
            infoEmpty: 'No software to display',
            infoFiltered: '(filtered from _MAX_ total software products)'
        }
    });
    
    // Initialize tooltips for action buttons
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}
