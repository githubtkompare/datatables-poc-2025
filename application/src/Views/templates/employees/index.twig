{% extends "base.twig" %}

{% block page_actions %}
    {% set current_auth = auth() %}
    {% if current_auth.is_admin %}
        <div class="btn-toolbar">
            <a href="/employees/create" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Add Employee
            </a>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table id="employeesTable" class="table table-striped table-hover nowrap" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th data-priority="1">Name</th>
                        <th data-priority="2">Email</th>
                        <th data-priority="4">Phone</th>
                        <th data-priority="3">University Unit</th>
                        <th data-priority="5">Job Title</th>
                        <th data-priority="6">Role Assignments</th>
                        <th data-priority="7">Created</th>
                        {% set current_auth = auth() %}
                        {% if current_auth.is_admin %}
                        <th data-priority="1">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    var currentAuth = {{ auth() | json_encode | raw }};
    
    // Define columns array
    var columns = [
        { 
            data: 'name',
            render: function(data, type, row) {
                return '<a href="/employees/' + row.id + '" class="text-decoration-none">' + 
                       '<i class="fas fa-user me-1"></i>' + data + '</a>';
            },
            responsivePriority: 1
        },
        { 
            data: 'email',
            render: function(data, type, row) {
                return '<a href="mailto:' + data + '" class="text-decoration-none">' + data + '</a>';
            },
            responsivePriority: 2
        },
        { 
            data: 'phone',
            render: function(data, type, row) {
                return data || '<span class="text-muted">N/A</span>';
            },
            responsivePriority: 4
        },
        { 
            data: 'university_unit_name',
            render: function(data, type, row) {
                return data || '<span class="text-muted">Not Assigned</span>';
            },
            responsivePriority: 3
        },
        { 
            data: 'job_title',
            render: function(data, type, row) {
                return data || '<span class="text-muted">N/A</span>';
            },
            responsivePriority: 5
        },
        { 
            data: null,
            render: function(data, type, row) {
                var badges = [];
                if (row.business_owner_count > 0) {
                    badges.push('<span class="badge bg-primary me-1" title="Business Owner roles">' + 
                               '<i class="fas fa-briefcase me-1"></i>' + row.business_owner_count + '</span>');
                }
                if (row.technical_owner_count > 0) {
                    badges.push('<span class="badge bg-success me-1" title="Technical Owner roles">' + 
                               '<i class="fas fa-cog me-1"></i>' + row.technical_owner_count + '</span>');
                }
                if (row.technical_manager_count > 0) {
                    badges.push('<span class="badge bg-info me-1" title="Technical Manager roles">' + 
                               '<i class="fas fa-users-cog me-1"></i>' + row.technical_manager_count + '</span>');
                }
                return badges.length > 0 ? badges.join('') : '<span class="text-muted">None</span>';
            },
            orderable: false,
            responsivePriority: 6
        },
        { 
            data: 'created_at',
            responsivePriority: 7
        }
    ];

    // Add actions column only if user is admin
    if (currentAuth.is_admin) {
        columns.push({ 
            data: null,
            render: function(data, type, row) {
                var actions = '<div class="btn-group btn-group-sm table-actions" role="group">' +
                       '<a href="/employees/' + row.id + '/edit" class="btn btn-outline-warning btn-sm" title="Edit">' +
                       '<i class="fas fa-edit"></i></a>' +
                       '<button type="button" class="btn btn-outline-danger btn-sm" title="Delete" ' +
                       'onclick="confirmDelete(\'employee\', ' + row.id + ', \'' + row.name.replace(/'/g, "\\'") + '\', \'/employees/delete\')">' +
                       '<i class="fas fa-trash"></i></button></div>';
                return actions;
            },
            orderable: false,
            searchable: false,
            responsivePriority: 1
        });
    }
    
    $('#employeesTable').DataTable({
        processing: true,
        serverSide: true,
        responsive: true,
        ajax: {
            url: '/employees/data',
            type: 'GET'
        },
        columns: columns, 
        columns: columns,
        order: [[0, 'asc']],
        pageLength: 25,
        scrollX: true,
        language: {
            processing: '<div class="d-flex align-items-center">' +
                       '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' +
                       'Loading employees...</div>',
            emptyTable: 'No employees found',
            info: 'Showing _START_ to _END_ of _TOTAL_ employees',
            infoEmpty: 'No employees to display',
            infoFiltered: '(filtered from _MAX_ total employees)'
        }
    });
    
    // Initialize tooltips for action buttons
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}
